name: Build/release

on:
  push:
    tags:
      - "*"
  workflow_dispatch:

jobs:
  release_to_tencent_cloud:
    strategy:
      matrix:
        include:
          # Windows 构建
          - os: windows-latest
            platform: win
            arch: x64
          # - os: windows-11-arm
          #   platform: win
          #   arch: arm64
            
          # macOS 构建
          - os: macos-13
            platform: mac
            arch: x64
          - os: macos-latest
            platform: mac
            arch: arm64
            
          # Linux 构建
          - os: ubuntu-latest
            platform: linux
            arch: x64
          - os: ubuntu-22.04-arm
            platform: linux
            arch: arm64

    runs-on: ${{ matrix.os }}

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v5

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          # electron的不同版本有专门对应的node版本，当前项目electron35对应的是22.14
          node-version: "22.14"
      
      # 在GitHub Action当中应该使用uses: pnpm/action-setup而不是npm install pnpm
      - name: Npm Install
        uses: pnpm/action-setup@v4
        with:
          run_install: true

      - name: Build Change Logs
        run: npm run changelog:current

      - name: Set Env
        run: |
          echo "BUILDTIME=$(TZ=Asia/Shanghai date)" >> $GITHUB_ENV
          VERSION=$(jq -r .version package.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "DOWNLOAD_URL=https://github.com/ocsjs/ocs-desktop/releases/download/$VERSION/" >> $GITHUB_ENV
          echo "PLATFORM=${{ matrix.platform }}" >> $GITHUB_ENV
          echo "ARCH=${{ matrix.arch }}" >> $GITHUB_ENV
        shell: bash
        
      - name: Fetch Change logs
        if: runner.os == 'Linux' && matrix.arch == 'x64'
        run: |
          if [ -f "CHANGELOG_CURRENT.md" ]; then
            CHANGE_LOGS=$(awk '/^## v/{if(flag) exit; flag=1} flag' CHANGELOG_CURRENT.md)
            if [ -n "$CHANGE_LOGS" ]; then
              echo "Found change logs"
              echo "CHANGE_LOGS<<EOF" >> $GITHUB_ENV
              echo "$CHANGE_LOGS" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            else
              echo "No change sections found in CHANGELOG_CURRENT.md"
            fi
          else
            echo "CHANGELOG_CURRENT.md file not found"
          fi
        shell: bash
        
      - name: Generate release.txt
        if: runner.os == 'Linux' && matrix.arch == 'x64'
        run: |
          if [ -z "$CHANGE_LOGS" ]; then
            echo "No change logs found, using default message"
            CHANGE_LOGS="More new features are now supported. Check for detailed changelog soon."
          else
            echo "Using found change logs"
          fi

          cat > release.txt << EOF
          $CHANGE_LOGS

          ## 下载地址

          ### Windows (不支持Win7)
          - [64位(常用)](${{ env.DOWNLOAD_URL }}ocs-${{ env.VERSION }}-setup-win-x64.exe) | [64位(压缩包版本)](${{ env.DOWNLOAD_URL }}ocs-${{ env.VERSION }}-setup-win-x64.zip) | [ARM64(不常用)](${{ env.DOWNLOAD_URL }}ocs-${{ env.VERSION }}-setup-win-arm64.exe)
          ### macOS
          - [M系列芯片](${{ env.DOWNLOAD_URL }}ocs-${{ env.VERSION }}-setup-mac-arm64.dmg) | [Intel芯片](${{ env.DOWNLOAD_URL }}ocs-${{ env.VERSION }}-setup-mac-x64.dmg)

          ### Linux
          - [AppImage](${{ env.DOWNLOAD_URL }}ocs-${{ env.VERSION }}-setup-linux-x86_64.AppImage)

          ### 快捷访问
          - [官网](https://docs.ocsjs.com/)
          - [官网软件下载（更快）](https://docs.ocsjs.com/docs/app)

          Created at ${{ env.BUILDTIME }}.
          EOF

      - name: Build
        run: npm run build
        env:
          USE_HARD_LINKS: false
          PLATFORM: ${{ matrix.platform }}
          ARCH: ${{ matrix.arch }}

      - name: Upload Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          body_path: "./release.txt"
          files: "./packages/app/dist/**.exe,./packages/app/dist/**.dmg,./packages/app/dist/**.AppImage,./packages/app/dist/**.zip,./packages/app/dist/**.deb,./packages/app/dist/**.rpm"

      - name: 安装腾讯云 CLI
        if: runner.os == 'Linux' && matrix.arch == 'x64'
        run: pip install coscmd

      - name: 配置腾讯云 COS 认证
        if: runner.os == 'Linux' && matrix.arch == 'x64'
        run: |
          coscmd config -a ${{ secrets.TENCENT_SECRET_ID }} -s ${{ secrets.TENCENT_SECRET_KEY }} -b ${{ secrets.COS_BUCKET }} -r ${{ secrets.COS_REGION }}

      - name: 上传到腾讯云 COS
        if: runner.os == 'Linux' && matrix.arch == 'x64'
        #  每个打包成非安装包的文件夹下都会有，chrome.zip，这里要删除，只上传安装包文件，里面自带编译了 chrome.zip 内置谷歌浏览器
        run: |
          coscmd upload -r packages/app/dist/ /app/download/${{ env.VERSION }}/  --include *.zip,*.exe,*.dmg,*.AppImage,*.deb,*.rpm  --ignore  "**/*/chrome.zip"
